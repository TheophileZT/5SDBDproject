name: docker-ci

on:
  push:
    branches:
      - FutureDataService
    paths:
      - 'Inference/**'
      - 'Frontend/**'
      - 'StationService/**'
      - 'EventImpactScoringSystem/**'
      - 'FetchFutureDataService/**'
      - 'docker-compose.yml'
  pull_request:
    branches:
      - FutureDataService

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      inference_changed: ${{ steps.determine-changes.outputs.inference_changed }}
      frontend_changed: ${{ steps.determine-changes.outputs.frontend_changed }}
      stationservice_changed: ${{ steps.determine-changes.outputs.stationservice_changed }}
      eventimpactscoringsystem_changed: ${{ steps.determine-changes.outputs.eventimpactscoringsystem_changed }}
      fetchfuturedataservice_changed: ${{ steps.determine-changes.outputs.fetchfuturedataservice_changed }}
      docker_compose_changed: ${{ steps.determine-changes.outputs.docker_compose_changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Fetch the previous commit

      - name: Determine changed directories
        id: determine-changes
        run: |
          changed_dirs=$(git diff --name-only HEAD~1 HEAD | xargs -I {} dirname {} | sort | uniq)
          echo "Changed directories: $changed_dirs"
          echo "::set-output name=inference_changed::false"
          echo "::set-output name=frontend_changed::false"
          echo "::set-output name=stationservice_changed::false"
          echo "::set-output name=eventimpactscoringsystem_changed::false"
          echo "::set-output name=fetchfuturedataservice_changed::false"
          echo "::set-output name=docker_compose_changed::false"
          for dir in $changed_dirs; do
            if [ "$dir" == "Inference" ]; then
              echo "::set-output name=inference_changed::true"
            elif [ "$dir" == "Frontend" ]; then
              echo "::set-output name=frontend_changed::true"
            elif [ "$dir" == "StationService" ]; then
              echo "::set-output name=stationservice_changed::true"
            elif [ "$dir" == "EventImpactScoringSystem" ]; then
              echo "::set-output name=eventimpactscoringsystem_changed::true"
            elif [ "$dir" == "FetchFutureDataService" ]; then
              echo "::set-output name=fetchfuturedataservice_changed::true"
            elif [ "$dir" == "docker-compose.yml" ]; then
              echo "::set-output name=docker_compose_changed::true"
            fi
          done

  build-and-deploy-inference:
    needs: check-changes
    if: needs.check-changes.outputs.inference_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Build and push Inference Docker image
        run: |
          echo "Building Inference..."
          # Add your build and push commands here

  build-and-deploy-frontend:
    needs: check-changes
    if: needs.check-changes.outputs.frontend_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Build and push Frontend Docker image
        run: |
          echo "Building Frontend..."
          # Add your build and push commands here

  build-and-deploy-stationservice:
    needs: check-changes
    if: needs.check-changes.outputs.stationservice_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Build and push StationService Docker image
        run: |
          echo "Building StationService..."
          # Add your build and push commands here

  build-and-deploy-eventimpactscoringsystem:
    needs: check-changes
    if: needs.check-changes.outputs.eventimpactscoringsystem_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Build and push EventImpactScoringSystem Docker image
        run: |
          echo "Building EventImpactScoringSystem..."
          # Add your build and push commands here

  build-and-deploy-fetchfuturedataservice:
    needs: check-changes
    if: needs.check-changes.outputs.fetchfuturedataservice_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Build and push FetchFutureDataService Docker image
        run: |
          echo "Building FetchFutureDataService..."
          # Add your build and push commands here

  build-and-deploy-dockercompose:
    needs: check-changes
    if: needs.check-changes.outputs.docker_compose_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Deploy Docker Compose changes
        run: |
          echo "Deploying Docker Compose changes..."
          # Add your deployment commands here